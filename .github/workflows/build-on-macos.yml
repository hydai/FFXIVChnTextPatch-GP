name: Build on MacOS

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

on:
  push:
    branch:
      - master
      - hydai
    tags:
      - "v*.*.*"
      - "*.*.*"
  pull_request:
    branch:
      - master
      - hydai

jobs:
  build_on_macos:
    runs-on: macos-12
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Install OpenJDK@11
        run: |
          brew install openjdk@11
      - name: Install Gradle
        run: |
          wget https://services.gradle.org/distributions/gradle-6.8.3-bin.zip
          unzip gradle-6.8.3-bin.zip
      - name: Download univocity-parsers
        run: |
          mkdir -p libs
          cd libs
          wget https://oss.sonatype.org/service/local/repositories/releases/content/com/univocity/univocity-parsers/2.9.1/univocity-parsers-2.9.1.jar
      - name: Build
        run: |
          export PATH="$(brew --prefix)/opt/openjdk@11/bin:$PATH"
          export PATH="${GITHUB_WORKSPACE}/gradle-6.8.3/bin:$PATH"
          export JAVA_HOME="$(brew --prefix)/opt/openjdk@11/libexec/openjdk.jdk/Contents/Home"
          gradle build
          gradle packageMacApp
      - name: Prepare universal JRE 11
        run: |
          bash ./.github/script/uni_jre.sh
          # Universal JRE will be ${GITHUB_WORKSPACE}/jre
      - name: Package distributions
        run: |
          # Prepare workspace
          mkdir -p workspace
          cp -r ./build/FFXIVChnTextPatch-GP_unspecified.dmg ./workspace/FFXIVChnTextPatch-GP-Intel.dmg
          cp -r ./build/FFXIVChnTextPatch-GP.app ./workspace/FFXIVChnTextPatch-GP.app
          cp ./build/distributions/FFXIVChnTextPatch-GP.zip ./workspace
          # Current path: ${GITHUB_WORKSPACE}
          cd workspace
          # Handle zip version
          # Current path: ${GITHUB_WORKSPACE}/workspace
          unzip ./FFXIVChnTextPatch-GP.zip
          rm ./FFXIVChnTextPatch-GP.zip
          cd FFXIVChnTextPatch-GP
          # Current path: ${GITHUB_WORKSPACE}/workspace/FFXIVChnTextPatch-GP
          cp -r ../../conf ./
          cp -r ../../resource ./
          # Create a shortcut
          cp ../../.github/script/FFXIVChnTextPatchGP ./
          cd ../
          # Current path: ${GITHUB_WORKSPACE}/workspace
          zip -r FFXIVChnTextPatch-GP-macOS.zip FFXIVChnTextPatch-GP/ -x "*.DS_Store"

          # Handle app version
          rm -rf ./workspace/FFXIVChnTextPatchGP.app/Contents/PlugIns/jre.jre
          mv -f ../jre ./workspace/FFXIVChnTextPatchGP.app/Contents/PlugIns/jre.jre
          zip -r FFXIVChnTextPatch-GP-app.zip FFXIVChnTextPatch-GP.app -x "*.DS_Store"
      - name: Upload zip
        uses: actions/upload-artifact@v3
        with:
          name: FFXIVChnTextPatch-GP-macOS
          path: ./workspace/FFXIVChnTextPatch-GP-macOS.zip
      - name: Upload app
        uses: actions/upload-artifact@v3
        with:
          name: FFXIVChnTextPatch-GP-macOS-app
          path: ./workspace/FFXIVChnTextPatch-GP-app.zip
      - name: Upload dmg
        uses: actions/upload-artifact@v3
        with:
          name: FFXIVChnTextPatch-GP-macOS-dmg
          path: ./workspace/FFXIVChnTextPatch-GP-Intel.dmg
      - name: Release macOS assets
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          body_path: macOS-CHANGELOG.txt
          files: |
            ./workspace/FFXIVChnTextPatch-GP-macOS.zip
            ./workspace/FFXIVChnTextPatch-GP-app.zip
            ./workspace/FFXIVChnTextPatch-GP-Intel.dmg
